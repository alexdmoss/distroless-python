# ---------------------- Templates ---------------------- #

.build:
  image: mosstech/gcloud-and-docker:390.0.0
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
  services:
  - docker:dind
  before_script:
  - sleep 5  # allow time for docker startup

.test:
  image: mosstech/gcloud-and-docker:390.0.0
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
  services:
  - docker:dind
  before_script:
  - sleep 5  # allow time for docker startup

.basic-tests:
  stage: basic-tests
  extends:
  - .test

.advanced-tests:
  stage: advanced-tests
  extends:
  - .test
  - .test_variables

# --------------- Build Stage Templates ----------------- #

.build-builder:
  stage: build-builder
  extends:
  - .build
  script:
  - ./scripts/build-builder.sh

.build-distroless:
  stage: build-distroless
  extends:
  - .build
  script:
  - ./scripts/build-distroless.sh

.scan:
  stage: scan
  extends:
  - .build
  script:
  - ./scripts/scan.sh

.publish:
  stage: publish
  extends:
  - .build
  script:
  - ./scripts/publish.sh
  only:
  - main

# ----------------- Basic Test Stages ------------------- #

.test-version:
  extends:
  - .basic-tests
  script:
  - ./scripts/tests.sh --target version

.test-version-debug:
  extends:
  - .basic-tests
  script:
  - ./scripts/tests.sh --target version --debug

.test-hello-world:
  extends:
  - .basic-tests
  script:
  - ./scripts/tests.sh --target hello-world

.test-hello-world-debug:
  extends:
  - .basic-tests
  script:
  - ./scripts/tests.sh --target hello-world --debug

# ---------------- Advanced Test Stages ----------------- #

.test-gunicorn:
  extends:
  - .advanced-tests
  script:
  - ./scripts/tests.sh --target gunicorn

.test-fastapi:
  extends:
  - .advanced-tests
  script:
  - ./test.sh --target fastapi
